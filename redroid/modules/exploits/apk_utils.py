#!/usr/bin/env python3
"""
APK utilities (signing)
"""

import os
import subprocess
import requests
from colorama import Fore, Style

def sign_apk(apk_path):
    """
    Sign an APK using either objection or uber-apk-signer.
    Returns the path to the signed APK or None if signing failed.
    """
    print(f"\n{Fore.CYAN}Do you want to sign the APK?{Style.RESET_ALL}")
    print("1. Yes, using objection")
    print("2. Yes, using uber-apk-signer")
    print("3. No, keep unsigned")
    
    choice = input(Fore.CYAN + "Enter your choice (1/2/3): " + Style.RESET_ALL).strip()
    
    if choice == "1":
        # Use objection
        try:
            print(Fore.CYAN + "üîß Signing APK with objection..." + Style.RESET_ALL)
            result = subprocess.run(['objection', 'patchapk', '-s', apk_path], 
                                  capture_output=True, text=True, check=True)
            print(Fore.GREEN + "‚úÖ APK signed successfully with objection!" + Style.RESET_ALL)
            if result.stdout:
                print(Fore.YELLOW + f"Output: {result.stdout}" + Style.RESET_ALL)
            return apk_path
        except subprocess.CalledProcessError as e:
            print(Fore.RED + f"‚ùå Error signing with objection: {e}" + Style.RESET_ALL)
            if e.stderr:
                print(Fore.RED + f"Error details: {e.stderr}" + Style.RESET_ALL)
            return None
        except FileNotFoundError:
            print(Fore.RED + "‚ùå objection not found. Please install it using 'pip install objection'." + Style.RESET_ALL)
            return None
    
    elif choice == "2":
        # Use uber-apk-signer
        try:
            print(Fore.CYAN + "üîç Checking for latest uber-apk-signer release..." + Style.RESET_ALL)
            
            response = requests.get("https://api.github.com/repos/patrickfav/uber-apk-signer/releases/latest", timeout=15)
            response.raise_for_status()
            release_data = response.json()
            
            jar_url = None
            jar_filename = None
            for asset in release_data.get("assets", []):
                if asset["name"].endswith(".jar") and "uber-apk-signer" in asset["name"]:
                    jar_url = asset["browser_download_url"]
                    jar_filename = asset["name"]
                    break
            
            if not jar_url:
                print(Fore.RED + "‚ùå Could not find uber-apk-signer JAR in latest release." + Style.RESET_ALL)
                return None
            
            if not os.path.exists(jar_filename):
                print(Fore.CYAN + f"üì• Downloading {jar_filename}..." + Style.RESET_ALL)
                with requests.get(jar_url, stream=True) as r:
                    r.raise_for_status()
                    with open(jar_filename, 'wb') as f:
                        for chunk in r.iter_content(chunk_size=8192):
                            f.write(chunk)
                print(Fore.GREEN + f"‚úÖ Downloaded {jar_filename}" + Style.RESET_ALL)
            else:
                print(Fore.GREEN + f"‚úÖ Using existing {jar_filename}" + Style.RESET_ALL)
            
            print(Fore.CYAN + "üîß Signing APK with uber-apk-signer..." + Style.RESET_ALL)
            cmd = ['java', '-jar', jar_filename, '-apk', apk_path]
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            
            print(Fore.GREEN + "‚úÖ APK signed successfully with uber-apk-signer!" + Style.RESET_ALL)
            if result.stdout:
                print(Fore.YELLOW + f"Output: {result.stdout}" + Style.RESET_ALL)
            
            base_name = os.path.splitext(apk_path)[0]
            signed_apk = f"{base_name}-aligned-debugSigned.apk"
            if os.path.exists(signed_apk):
                return signed_apk
            else:
                signed_apk = f"{base_name}-signed.apk"
                if os.path.exists(signed_apk):
                    return signed_apk
                else:
                    print(Fore.YELLOW + "‚ö†Ô∏è Signed APK location unclear, check current directory." + Style.RESET_ALL)
                    return apk_path
                    
        except requests.RequestException as e:
            print(Fore.RED + f"‚ùå Error downloading uber-apk-signer: {e}" + Style.RESET_ALL)
            return None
        except subprocess.CalledProcessError as e:
            print(Fore.RED + f"‚ùå Error signing with uber-apk-signer: {e}" + Style.RESET_ALL)
            if e.stderr:
                print(Fore.RED + f"Error details: {e.stderr}" + Style.RESET_ALL)
            return None
        except Exception as e:
            print(Fore.RED + f"‚ùå Unexpected error with uber-apk-signer: {e}" + Style.RESET_ALL)
            return None
    
    elif choice == "3":
        print(Fore.YELLOW + "‚ö†Ô∏è APK will remain unsigned." + Style.RESET_ALL)
        return apk_path
    
    else:
        print(Fore.RED + "‚ùå Invalid choice. APK will remain unsigned." + Style.RESET_ALL)
        return apk_path


